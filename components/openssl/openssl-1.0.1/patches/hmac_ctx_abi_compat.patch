Revert 
https://github.com/openssl/openssl/commit/2674af2f790aa1c869dcf5f2024e9eb6758edf56
as it breaks ABI

diff -ur openssl-1.0.1n-orig/crypto/hmac/hmac.c openssl-1.0.1n/crypto/hmac/hmac.c
--- openssl-1.0.1n-orig/crypto/hmac/hmac.c	2015-06-12 14:45:23.006617917 +0300
+++ openssl-1.0.1n/crypto/hmac/hmac.c	2015-06-12 14:50:44.819227595 +0300
@@ -91,14 +91,8 @@
     if (md != NULL) {
         reset = 1;
         ctx->md = md;
-    } else if (ctx->md) {
+    } else 
         md = ctx->md;
-    } else {
-        return 0;
-    }
-
-    if (!ctx->key_init && key == NULL)
-        return 0;
 
     if (key != NULL) {
         reset = 1;
@@ -121,7 +115,6 @@
         if (ctx->key_length != HMAC_MAX_MD_CBLOCK)
             memset(&ctx->key[ctx->key_length], 0,
                    HMAC_MAX_MD_CBLOCK - ctx->key_length);
-        ctx->key_init = 1;
     }
 
     if (reset) {
@@ -159,8 +152,6 @@
     if (FIPS_mode() && !ctx->i_ctx.engine)
         return FIPS_hmac_update(ctx, data, len);
 #endif
-    if (!ctx->key_init)
-        return 0;
 
     return EVP_DigestUpdate(&ctx->md_ctx, data, len);
 }
@@ -174,9 +165,6 @@
         return FIPS_hmac_final(ctx, md, len);
 #endif
 
-    if (!ctx->key_init)
-        goto err;
-
     if (!EVP_DigestFinal_ex(&ctx->md_ctx, buf, &i))
         goto err;
     if (!EVP_MD_CTX_copy_ex(&ctx->md_ctx, &ctx->o_ctx))
@@ -195,8 +183,6 @@
     EVP_MD_CTX_init(&ctx->i_ctx);
     EVP_MD_CTX_init(&ctx->o_ctx);
     EVP_MD_CTX_init(&ctx->md_ctx);
-    ctx->key_init = 0;
-    ctx->md = NULL;
 }
 
 int HMAC_CTX_copy(HMAC_CTX *dctx, HMAC_CTX *sctx)
@@ -207,11 +193,8 @@
         goto err;
     if (!EVP_MD_CTX_copy(&dctx->md_ctx, &sctx->md_ctx))
         goto err;
-    dctx->key_init = sctx->key_init;
-    if (sctx->key_init) {
-        memcpy(dctx->key, sctx->key, HMAC_MAX_MD_CBLOCK);
-        dctx->key_length = sctx->key_length;
-    }
+    memcpy(dctx->key, sctx->key, HMAC_MAX_MD_CBLOCK);
+    dctx->key_length = sctx->key_length;
     dctx->md = sctx->md;
     return 1;
  err:
diff -ur openssl-1.0.1n-orig/crypto/hmac/hmac.h openssl-1.0.1n/crypto/hmac/hmac.h
--- openssl-1.0.1n-orig/crypto/hmac/hmac.h	2015-06-12 14:45:23.006119404 +0300
+++ openssl-1.0.1n/crypto/hmac/hmac.h	2015-06-12 14:50:56.753594425 +0300
@@ -79,7 +79,6 @@
     EVP_MD_CTX o_ctx;
     unsigned int key_length;
     unsigned char key[HMAC_MAX_MD_CBLOCK];
-    int key_init;
 } HMAC_CTX;
 
 # define HMAC_size(e)    (EVP_MD_size((e)->md))
